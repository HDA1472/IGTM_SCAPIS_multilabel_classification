---
title: "differential_expression"
format: html
editor: source
---

```{r setup, message = FALSE, warning = FALSE, results = 'hide'}
library(HDAnalyzeR)
library(tidyverse)
library(tidyheatmaps)
```

# Import data & metadata

```{r, message = FALSE, results = 'hide'}
data_scapis <- import_df("data/processed_data/scapis_joined_preprocessed.rda")
data_igt <- import_df("data/processed_data/igt_joined_preprocessed.rda")
metadata <- import_df("data/processed_data/metadata_preprocessed.rda")
```

# Differential Expression - limma

```{r}
disease_vec <- c("Obesity", "IGT", "T2D", "MS", "MASLD", "Carotid_plaque", "CAC")
```

```{r}
disease_palette <- c("Obesity" = "#A6CEE3", 
                     "IGT" = "#836879", 
                     "T2D" = "#321433",
                     "MS" = "#08585A", 
                     "MASLD" = "#FFD321", 
                     "Carotid_plaque" = "#E8A29A", 
                     "CAC" = "#9E0142")
```

```{r}
metadata_cols <- c("Sex", "Age", "Smoke_status", "MAP_Mean", "HbA1c", "Chol", "LDL", "HDL", "TG", "ALT", "GGT", "Urate", "Crea", "eGFR", "CRP", "Hb", "WBC", "PLT")
```

```{r}
res <- lapply(disease_vec, function(disease) {
  print(paste(disease, "Case:"))
  
  discovery_cohort <- data_igt |>
    select(-all_of(disease_vec)) |> 
    select(-any_of(metadata_cols))
  
  if (disease == "Obesity") {
    correct <- c("Age", "Sex")
    correct_type <- c("numeric", "factor")
  } else {
    correct <- c("Age", "Sex", "BMI")
    correct_type <- c("numeric", "factor", "numeric")
  }
  de_res <- do_limma(discovery_cohort, 
                     metadata |> rename(Disease = disease), 
                     "Disease", 
                     case = 1, 
                     control = 0,
                     correct = correct,
                     correct_type = correct_type,
                     logfc_lim = 0)
})

names(res) <- disease_vec
```

```{r}
de_all <- lapply(disease_vec, function(disease) {
    de_res <- res[[disease]]$de_results |> mutate(Disease = disease)
  })
de_all <- bind_rows(de_all)
```

# Analysis of DE results

Top 20 proteins for each disease according to logFC. LogFC > 0.1 and adj.P.val < 0.05.

```{r}
top_proteins <- de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(20, logFC) |> 
  ungroup() |> 
  pull(Assay)

de_all |>
  filter(Assay %in% top_proteins) |>
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2")
```

Stricter filtering.

```{r}
de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.5) |> 
  arrange(desc(logFC)) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2")
```

## Annotate proteins with LASSO importance

```{r}
lasso_onlyproteins_features <- readRDS("results/models_results/lasso_onlyproteins_features.RData")
lasso_onlyproteins <- readRDS(res, file="results/models/lasso_binary_onlyproteins.RData")
```

Binary annotation of proteins with importance > 50.

```{r}
disease_palette <- list(Obesity = c("0" = "white", "1" = "#A6CEE3"), 
                        IGT = c("0" = "white", "1" = "#836879"), 
                        T2D = c("0" = "white", "1" = "#321433"),
                        MS = c("0" = "white", "1" = "#08585A"), 
                        MASLD = c("0" = "white", "1" = "#FFD321"), 
                        Carotid_plaque = c("0" = "white", "1" = "#E8A29A"), 
                        CAC = c("0" = "white", "1" = "#9E0142"))

binary_disease_cols <- lasso_onlyproteins_features |> 
  filter(Scaled_Importance > 50) |> 
  select(-Importance, -Sign) |> 
  pivot_wider(names_from = Disease, values_from = Scaled_Importance) |> 
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), 0, 1))) |> 
  rename(Protein = Variable)

top_proteins <- de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(20, logFC) |> 
  ungroup() |> 
  pull(Assay)

de_all |>
  filter(Assay %in% top_proteins) |>
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  left_join(binary_disease_cols, by = "Protein") |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    annotation_col = c("Obesity", "IGT", "T2D", "MS", "MASLD", "Carotid_plaque", "CAC"),
    annotation_colors = disease_palette,
    annotation_legend = FALSE,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2"
  )
```

Continuous importance annotation. >0 filtering.

Metabolic syndrome is very interesting as the features with more than 50% (except 1) are not differentially expressed. However, MS is predicted with an AUC of 0.86.

```{r}
disease_palette <- list(Obesity = c("0" = "white", "100" = "#A6CEE3"), 
                        IGT = c("0" = "white", "100" = "#836879"), 
                        T2D = c("0" = "white", "100" = "#321433"),
                        MS = c("0" = "white", "100" = "#08585A"), 
                        MASLD = c("0" = "white", "100" = "#FFD321"), 
                        Carotid_plaque = c("0" = "white", "1" = "#E8A29A"), 
                        CAC = c("0" = "white", "100" = "#9E0142"))

binary_disease_cols <- lasso_onlyproteins_features |> 
  filter(Scaled_Importance > 0) |> 
  select(-Importance, -Sign) |> 
  pivot_wider(names_from = Disease, values_from = Scaled_Importance) |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  rename(Protein = Variable)

top_proteins <- de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(20, logFC) |> 
  ungroup() |> 
  pull(Assay)

de_all |>
  filter(Assay %in% top_proteins) |>
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  left_join(binary_disease_cols, by = "Protein") |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    annotation_col = c("Obesity", "IGT", "T2D", "MS", "MASLD", "Carotid_plaque", "CAC"),
    annotation_colors = disease_palette,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2"
  )
```