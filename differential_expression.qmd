---
title: "differential_expression"
format: html
editor: source
---

```{r setup, message = FALSE, warning = FALSE, results = 'hide'}
library(HDAnalyzeR)
library(tidyverse)
library(tidyheatmaps)
library(forcats)
library(patchwork)
```

# Import data & metadata

```{r, message = FALSE, results = 'hide'}
data_scapis <- import_df("data/processed_data/scapis_joined_preprocessed.rda")
data_igt <- import_df("data/processed_data/igt_joined_preprocessed.rda")
metadata <- import_df("data/processed_data/metadata_preprocessed.rda")
```

# Differential Expression - limma

```{r}
disease_vec <- c("Obesity", "IGT", "T2D", "MS", "MASLD", "Carotid_plaque", "CAC")
```

```{r}
disease_palette <- c("Obesity" = "#A6CEE3", 
                     "IGT" = "#836879", 
                     "T2D" = "#321433",
                     "MS" = "#08585A", 
                     "MASLD" = "#FFD321", 
                     "Carotid_plaque" = "#E8A29A", 
                     "CAC" = "#9E0142")
```

```{r}
metadata_cols <- c("Sex", "Age", "Smoke_status", "MAP_Mean", "HbA1c", "Chol", "LDL", "HDL", "TG", "ALT", "GGT", "Urate", "Crea", "eGFR", "CRP", "Hb", "WBC", "PLT")
```

## IGT

```{r}
res_igt <- lapply(disease_vec, function(disease) {
  print(paste(disease, "Case:"))
  
  discovery_cohort <- data_igt |>
    select(-all_of(disease_vec)) |> 
    select(-any_of(metadata_cols))
  
  if (disease == "Obesity") {
    correct <- c("Age", "Sex")
    correct_type <- c("numeric", "factor")
  } else {
    correct <- c("Age", "Sex", "BMI")
    correct_type <- c("numeric", "factor", "numeric")
  }
  de_res <- do_limma(discovery_cohort, 
                     metadata |> rename(Disease = disease), 
                     "Disease", 
                     case = 1, 
                     control = 0,
                     correct = correct,
                     correct_type = correct_type,
                     logfc_lim = 0)
})

names(res_igt) <- disease_vec
```

```{r}
de_all_igt <- lapply(disease_vec, function(disease) {
    de_res <- res_igt[[disease]]$de_results |> mutate(Disease = disease)
  })
de_all_igt <- bind_rows(de_all_igt)
```

```{r}
volcanos_all_igt <- lapply(disease_vec, function(disease) {
    de_res <- res_igt[[disease]]$volcano_plot
  })

names(volcanos_all_igt) <- disease_vec
```

## SCAPIS

```{r}
res_scapis <- lapply(disease_vec, function(disease) {
  print(paste(disease, "Case:"))
  
  discovery_cohort <- data_scapis |>
    select(-all_of(disease_vec)) |> 
    select(-any_of(metadata_cols))
  
  if (disease == "Obesity") {
    correct <- c("Age", "Sex")
    correct_type <- c("numeric", "factor")
  } else {
    correct <- c("Age", "Sex", "BMI")
    correct_type <- c("numeric", "factor", "numeric")
  }
  de_res <- do_limma(discovery_cohort, 
                     metadata |> rename(Disease = disease), 
                     "Disease", 
                     case = 1, 
                     control = 0,
                     correct = correct,
                     correct_type = correct_type,
                     logfc_lim = 0)
})

names(res_scapis) <- disease_vec
```

```{r}
de_all_scapis <- lapply(disease_vec, function(disease) {
    de_res <- res_scapis[[disease]]$de_results |> mutate(Disease = disease)
  })
de_all_scapis <- bind_rows(de_all_scapis)
```

```{r}
volcanos_all_scapis <- lapply(disease_vec, function(disease) {
    de_res <- res_scapis[[disease]]$volcano_plot
  })

names(volcanos_all_scapis) <- disease_vec
```

# Analysis of DE results

## Top proteins boxplots

```{r}
disease_palette_boxplot <- c("Obesity" = "#A6CEE3", 
                             "IGT" = "#836879", 
                             "T2D" = "#321433",
                             "MS" = "#08585A", 
                             "MASLD" = "#FFD321", 
                             "Carotid_plaque" = "#E8A29A", 
                             "CAC" = "#9E0142",
                             "Other Disease" = "lightgrey",
                             "Healthy" = "lightgrey")

top_proteins <- de_all_igt |> 
  filter(adj.P.Val < 0.05) |> 
  group_by(Disease) |>
  arrange(Disease, desc(logFC)) |>
  slice_head(n = 3) |> 
  ungroup() |> 
  rename(Protein = Assay)

top_proteins_vec <- top_proteins |> 
  pull(Protein)

plot_data <- data_igt |> 
  select(DAid, all_of(disease_vec), all_of(top_proteins_vec)) |> 
  pivot_longer(cols = -c(DAid, disease_vec), names_to = "Protein", values_to = "Value") |> 
  left_join(top_proteins |> select(Protein, Disease) |> unique(), 
            by = "Protein", 
            relationship = "many-to-many") |> 
  mutate(Disease_Value = case_when(
    Disease == "Obesity" ~ Obesity,
    Disease == "CAC" ~ CAC,
    Disease == "T2D" ~ T2D,
    Disease == "MS" ~ MS,
    Disease == "MASLD" ~ MASLD,
    Disease == "Carotid_plaque" ~ Carotid_plaque,
    Disease == "IGT" ~ IGT,
    TRUE ~ NA_real_
  )) |> 
  mutate(Any_disease = Obesity + CAC + T2D + MS + MASLD + Carotid_plaque + IGT) |> 
  mutate(Disease_Value = case_when(
    Disease_Value == 1 ~ Disease,
    Any_disease == 0 ~ "Healthy",
    Disease_Value == 0 ~ "Other Disease",
    TRUE ~ "Control"  # Default case for NA values
  )) |> 
  mutate(Disease_protein = paste(Disease, Protein, sep = "_"))

plot_data |> 
  ggplot(aes(x = factor(Disease_Value, 
                        levels = c("Healthy", 
                                   "Other Disease", 
                                   unique(Disease[!is.na(Disease_Value)]))), 
             y = Value, 
             fill = Disease_Value)) +
  geom_boxplot(position = position_dodge(0.8), outlier.size = 1.5) +
  scale_fill_manual(values = disease_palette_boxplot) +
  facet_wrap(~Disease_protein, scales = "free") +
  labs(x = "", y = "") +
  theme_hpa() + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

## Protein heatmaps
Top 20 proteins for each disease according to logFC. LogFC > 0.1 and adj.P.val < 0.05.

```{r}
top_proteins <- de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(20, logFC) |> 
  ungroup() |> 
  pull(Assay)

de_all |>
  filter(Assay %in% top_proteins) |>
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2")
```

Stricter filtering.

```{r}
de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.5) |> 
  arrange(desc(logFC)) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2")
```

## Annotate proteins with LASSO importance

```{r}
lasso_onlyproteins_features <- readRDS("results/models_results/lasso_onlyproteins_features.RData")
lasso_onlyproteins <- readRDS(res, file="results/models/lasso_binary_onlyproteins.RData")
```

Binary annotation of proteins with importance > 50.

```{r}
disease_palette <- list(Obesity = c("0" = "white", "1" = "#A6CEE3"), 
                        IGT = c("0" = "white", "1" = "#836879"), 
                        T2D = c("0" = "white", "1" = "#321433"),
                        MS = c("0" = "white", "1" = "#08585A"), 
                        MASLD = c("0" = "white", "1" = "#FFD321"), 
                        Carotid_plaque = c("0" = "white", "1" = "#E8A29A"), 
                        CAC = c("0" = "white", "1" = "#9E0142"))

binary_disease_cols <- lasso_onlyproteins_features |> 
  filter(Scaled_Importance > 50) |> 
  select(-Importance, -Sign) |> 
  pivot_wider(names_from = Disease, values_from = Scaled_Importance) |> 
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), 0, 1))) |> 
  rename(Protein = Variable)

top_proteins <- de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(20, logFC) |> 
  ungroup() |> 
  pull(Assay)

de_all |>
  filter(Assay %in% top_proteins) |>
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  left_join(binary_disease_cols, by = "Protein") |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    annotation_col = c("Obesity", "IGT", "T2D", "MS", "MASLD", "Carotid_plaque", "CAC"),
    annotation_colors = disease_palette,
    annotation_legend = FALSE,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2"
  )
```

Continuous importance annotation. >0 filtering.

Metabolic syndrome is very interesting as the features with more than 50% (except 1) are not differentially expressed. However, MS is predicted with an AUC of 0.86.

```{r}
disease_palette <- list(Obesity = c("0" = "white", "100" = "#A6CEE3"), 
                        IGT = c("0" = "white", "100" = "#836879"), 
                        T2D = c("0" = "white", "100" = "#321433"),
                        MS = c("0" = "white", "100" = "#08585A"), 
                        MASLD = c("0" = "white", "100" = "#FFD321"), 
                        Carotid_plaque = c("0" = "white", "1" = "#E8A29A"), 
                        CAC = c("0" = "white", "100" = "#9E0142"))

binary_disease_cols <- lasso_onlyproteins_features |> 
  filter(Scaled_Importance > 0) |> 
  select(-Importance, -Sign) |> 
  pivot_wider(names_from = Disease, values_from = Scaled_Importance) |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  rename(Protein = Variable)

top_proteins <- de_all |> 
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(20, logFC) |> 
  ungroup() |> 
  pull(Assay)

de_all |>
  filter(Assay %in% top_proteins) |>
  filter(adj.P.Val < 0.05, logFC > 0.1) |> 
  select(Disease, Assay, logFC) |> 
  rename(Protein = Assay) |> 
  pivot_wider(names_from = Disease, values_from = logFC) |>
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  pivot_longer(cols = -Protein, names_to = "Disease", values_to = "logFC") |> 
  left_join(binary_disease_cols, by = "Protein") |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  tidyheatmap(
    rows = Disease,
    columns = Protein,
    values = logFC,
    colors = c("white", "red4"),
    annotation_col = c("Obesity", "IGT", "T2D", "MS", "MASLD", "Carotid_plaque", "CAC"),
    annotation_colors = disease_palette,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_colnames = TRUE,
    clustering_method = "ward.D2"
  )
```

## Validation analysis

```{r}
upreg_proteins_igt <- de_all_igt |> 
  select(Assay, Disease, logFC, adj.P.Val) |> 
  filter(logFC > 0, adj.P.Val < 0.05) |>
  arrange(desc(logFC)) |> 
  group_by(Disease) |>
  top_n(10, logFC) |>
  ungroup()
```

```{r}
plots <- list()

for (i in seq_along(disease_vec)) {
  disease <- disease_vec[i]
  
  p <- upreg_proteins_igt |> 
    filter(Disease == disease) |> 
    ggplot(aes(x = logFC, y = fct_reorder(Assay, logFC), color = Disease)) +
    geom_segment(aes(x = 0, xend = logFC, y = Assay, yend = Assay)) +
    geom_point(size = 4) +
    geom_vline(xintercept = 0.1, linetype = "dashed", color = "black") +
    scale_color_manual(values = disease_palette) +
    theme_hpa() +
    theme(legend.position = "none", plot.margin = margin(2, 0, 2, 0)) +
    xlim(0, 1.5) +
    labs(y = element_blank(), title = disease) +
    theme(axis.title.y = element_blank(), 
          axis.text.y = element_blank(), 
          axis.ticks.y = element_blank())
  
  # Remove x-axis and x-axis label for all but the last plot
  if (i < length(disease_vec)) {
    p <- p + theme(axis.line.x = element_blank(), 
                   axis.title.x = element_blank(), 
                   axis.text.x = element_blank(), 
                   axis.ticks.x = element_blank())
  } else {
    p <- p + labs(x = "logFC")
  }
  
  plots[[i]] <- p
}

combined_plot_igt <- wrap_plots(plots, ncol = 1) + 
  plot_annotation(title = 'IGT') &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
combined_plot_igt
```

```{r}
plots <- list()

for (i in seq_along(disease_vec)) {
  disease <- disease_vec[i]
  
  p <- upreg_proteins_igt |> 
    left_join(de_all_scapis |> select(Assay, Disease, logFC, adj.P.Val), 
              by = c("Assay", "Disease")) |>
    filter(Disease == disease) |> 
    ggplot(aes(x = logFC.y, y = fct_reorder(Assay, logFC.x), color = Disease)) +
    geom_segment(aes(x = 0, xend = logFC.y, y = Assay, yend = Assay)) +
    geom_point(size = 4) +
    geom_vline(xintercept = 0.1, linetype = "dashed", color = "black") +
    scale_color_manual(values = disease_palette) +
    theme_hpa() +
    theme(legend.position = "none", plot.margin = margin(2, 0, 2, 0)) +
    xlim(0, 1.5) +
    labs(y = element_blank(), title = disease) +
    theme(axis.title.y = element_blank(), 
          axis.text.y = element_blank(), 
          axis.ticks.y = element_blank())
  
  # Remove x-axis and x-axis label for all but the last plot
  if (i < length(disease_vec)) {
    p <- p + theme(axis.line.x = element_blank(), 
                   axis.title.x = element_blank(), 
                   axis.text.x = element_blank(), 
                   axis.ticks.x = element_blank())
  } else {
    p <- p + labs(x = "logFC")
  }
  
  plots[[i]] <- p
}

combined_plot_scapis <- wrap_plots(plots, ncol = 1) + 
  plot_annotation(title = 'SCAPIS') &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
combined_plot_scapis
```

```{r}
lasso_onlyproteins_features <- readRDS("results/models_results/lasso_onlyproteins_features.RData")
plots <- list()

for (i in seq_along(disease_vec)) {
  disease <- disease_vec[i]
  
  p <- upreg_proteins_igt |> 
    left_join(lasso_onlyproteins_features |> 
                rename(Assay = Variable) |> 
                mutate(Scaled_Importance = case_when(
                  Sign == "POS" ~ Scaled_Importance,
                  Sign == "NEG" ~ -Scaled_Importance,
                  TRUE ~ 0
                )) |> 
                select(Assay, Disease, Scaled_Importance), 
              by = c("Assay", "Disease")) |>
    filter(Disease == disease) |> 
    ggplot(aes(x = Scaled_Importance, y = fct_reorder(Assay, logFC), fill = Disease)) +
    geom_col() +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
    scale_fill_manual(values = disease_palette) +
    theme_hpa() +
    theme(legend.position = "none", plot.margin = margin(2, 0, 2, 0)) +
    xlim(-100, 100) +
    labs(y = element_blank(), title = disease)
  
  # Remove x-axis and x-axis label for all but the last plot
  if (i < length(disease_vec)) {
    p <- p + theme(axis.line.x = element_blank(), 
                   axis.title.x = element_blank(), 
                   axis.text.x = element_blank(), 
                   axis.ticks.x = element_blank())
  } else {
    p <- p + labs(x = "Protein Importance (%)")
  }
  
  plots[[i]] <- p
}

combined_plot_ml <- wrap_plots(plots, ncol = 1) + 
  plot_annotation(title = 'LASSO trained on IGT') &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
combined_plot_ml
```

```{r}
plots <- list()

for (i in seq_along(disease_vec)) {
  disease <- disease_vec[i]
  
  p <- upreg_proteins_igt |> 
    left_join(de_all_scapis |> select(Assay, Disease, logFC, adj.P.Val), 
              by = c("Assay", "Disease")) |>
    filter(Disease == disease) |> 
    mutate(Validate = ifelse(logFC.y > 0.1 & logFC.x > 0.1, 1, 0)) |>
    mutate(Validate = as.factor(Validate)) |> 
    ggplot(aes(x = "0", y = fct_reorder(Assay, logFC.x), fill = Validate)) +
    geom_point(shape=22, size = 4) +
    scale_fill_manual(values = c("1" = "green", "0" = "red")) +
    scale_x_discrete(breaks=c("0"), labels=c("YES/NO")) + 
    theme_hpa() +
    theme(legend.position = "none", plot.margin = margin(2, 0, 2, 0)) +
    labs(y = element_blank(), title = disease) +
    theme(axis.line.y = element_blank(), 
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(), 
          axis.ticks.y = element_blank())
  
  # Remove x-axis and x-axis label for all but the last plot
  if (i < length(disease_vec)) {
    p <- p + theme(axis.line.x = element_blank(),
                   axis.title.x = element_blank(),
                   axis.text.x = element_blank(),
                   axis.ticks.x = element_blank())
  } else {
    p <- p + labs(x = "")
  }
  
  plots[[i]] <- p
}

combined_plot_validate <- wrap_plots(plots, ncol = 1) + 
  plot_annotation(title = 'Validation') &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
combined_plot_validate
```

```{r}
# rm(combined_plot_ml)
# rm(combined_plot_igt)
# rm(combined_plot_scapis)
# rm(combined_plot_validate)
# rm(final_plot)
```

```{r, warnings = FALSE}
combined_plot_ml <- wrap_elements(full = combined_plot_ml) +
  plot_annotation(title = "LASSO trained on IGT") &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

combined_plot_igt <- wrap_elements(full = combined_plot_igt) +
  plot_annotation(title = "IGT Cohort") &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

combined_plot_scapis <- wrap_elements(full = combined_plot_scapis) +
  plot_annotation(title = "SCAPIS Cohort") &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

combined_plot_validate <- wrap_elements(full = combined_plot_validate) +
  plot_annotation(title = "Validation") &
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Combine the wrapped plots side-by-side
final_plot <- (combined_plot_ml | combined_plot_igt | combined_plot_scapis | combined_plot_validate) +
  plot_layout(widths = c(4, 3, 3, 1))
final_plot
```

