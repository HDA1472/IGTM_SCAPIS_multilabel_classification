---
title: "main"
format: html
editor: visual
---

# Set-up

```{r setup, message = FALSE, warning = FALSE, results = 'hide'}
library(HDAnalyzeR)
library(tidyverse)
library(ggridges)
library(tidyheatmaps)
library(corrplot)
```

# Import Data & Metadata

```{r, message = FALSE, results = 'hide'}
long_data <- import_df("data/raw_data/IGT_SCAPIS_preprocessed_data.tsv")

metadata <- import_df("data/raw_data/IGTM_SCAPIS_metadata_230406.txt")
metadata_scapis <- import_df("data/raw_data/scapis_metadata_manifest.xlsx")
metadata_igt <- import_df("data/raw_data/igts_metadata_manifest.xlsx")
```

# Data Preprocessing

## Prepare Data

Get the unique DAid from the metadata files (SCAPIS and IGT).

```{r}
scapis_DAid <- metadata_scapis$DAid |> unique()
igt_DAid <- metadata_igt$DAid |> unique()
```

Separate data and make them wide.

```{r}
data_scapis <- long_data |> filter(DAid %in% scapis_DAid)
data_igt <- long_data |> filter(DAid %in% igt_DAid)

data_scapis <- widen_data(data_scapis)
data_igt <- widen_data(data_igt)
```

See if the DAids of the data match the DAids of the metadata (both Goran's and manifest).

Check which DAids are different (if any) between the manifest metadata and the data.

```{r}
manifest_metadata <- rbind(metadata_scapis, metadata_igt)
missing_in_metadata <- setdiff(long_data$DAid, manifest_metadata$DAid)
print(missing_in_metadata)

missing_in_data <- setdiff(manifest_metadata$DAid, long_data$DAid)
print(missing_in_data)
```

Check which DAids are different (if any) between the Goran's metadata and the data.

```{r}
missing_in_metadata <- setdiff(long_data$DAid, metadata$DAid)
print(missing_in_metadata)

missing_in_data <- setdiff(metadata$DAid, long_data$DAid)
print(missing_in_data)
```

## Prepare metadata

Check different values in specified metadata columns. For the missing values we are going to check if they are coexisting in the same patients. For carotid plaque we are going to make it binary (YES/NO). For the glucose group we are going to make a binary variable called impaired glucose tolerance (NO - patients with T2D, IGT, CGI, IFG, YES - all others).

```{r}
metadata |> 
  select(all_of(c("glucose.group", "carotidplaque", "CAC", "NAFLD", "MetS_NCEP"))) |> 
  pivot_longer(everything(), names_to = "Variable", values_to = "Value") |> 
  group_by(Variable, Value) |> 
  summarise(Count = n(), .groups = 'drop') |> 
  arrange(Variable) |> 
  group_by(Variable) |> 
  summarise(Summary = paste(Value, "(", Count, ")", collapse = ", ")) |> 
  ungroup() |> 
  mutate(Summary = paste(Variable, ":", Summary)) |> 
  pull(Summary) |> 
  cat(sep = "\n")
```

> In `glucose.group` - CGI: Combined Glucose Impairment (both impaired fasting glucose (IFG) and impaired glucose tolerance (IGT)). NGT: Normal Glucose Tolerance, highFINDRISC (lowFINDRISC): high (low) score on the FINDRISC (Finnish Diabetes Risk Score), T2D_new: Newly Diagnosed Type 2 Diabetes.

Check for NA overlap.

```{r}
metadata |> 
  rowwise() |> 
  mutate(carotidplaque = if_else(carotidplaque == "NOT_APPLICABLE", NA, carotidplaque)) |> 
  mutate(NA_count = sum(is.na(across(all_of(c("CAC", "carotidplaque", "NAFLD", "MetS_NCEP", "glucose.group")))))) |> 
  ungroup() |> 
  filter(NA_count > 0) |> 
  select(DAid, NA_count) |> 
  arrange(desc(NA_count))
```

Rename and modify the metadata columns.
- Convert Sex from MALE/FEMALE to M/F.
- Convert carotidplaque to binary (NO/YES).
- Create Obesity (BMI > 30) and IGT (glucose.group %in% c("CGI", "IFG", "IGT", "T2D_new")) columns.
- Rename multiple columns to make them easier to understand.
- 01 encoding for the disease columns.

```{r}
metadata_preprocessed <- metadata |> 
  rename(Age = AgeAtVisitOne, 
         Sex = Gender,
         MS = MetS_NCEP, 
         MASLD = NAFLD,
         Myocardial_infarction = cqhe002, 
         Atrial_fibrillation = cqhe009,
         Coronary_artery_intervention = cqhe017,
         Stroke = cqhe029,
         COPD = cqhe043,
         Asthma = cqhe048,
         Tuberculosis = cqhe055,
         Sleep_apnea = cqhe058,
         Celiac_disease = cqhe063,
         Crohn = cqhe066,
         Rheumatic_disease = cqhe069) |> 
  mutate(Age = Age |> as.numeric() |> floor()) |> 
  mutate(Sex = if_else(Sex == "MALE", "M", "F")) |> 
  mutate(carotidplaque = if_else(carotidplaque == "NOT_APPLICABLE", NA, carotidplaque)) |> 
  mutate(Obesity = if_else(BMI > 30, 1, 0),
         IGT = if_else(glucose.group %in% c("CGI", "IFG", "IGT", "T2D_new"), 1, 0),
         carotidplaque = if_else(carotidplaque %in% c("NO_PLAQUE"), 0, 1),
         MS = if_else(MS == "YES", 1, 0),
         MASLD = if_else(MASLD == "YES", 1, 0),
         CAC = if_else(CAC == "YES", 1, 0),
         Myocardial_infarction = if_else(Myocardial_infarction == "YES", 1, 0),
         Atrial_fibrillation = if_else(Atrial_fibrillation == "YES", 1, 0),
         Coronary_artery_intervention = if_else(Coronary_artery_intervention == "YES", 1, 0),
         Stroke = if_else(Stroke == "YES", 1, 0),
         COPD = if_else(COPD == "YES", 1, 0),
         Asthma = if_else(Asthma == "YES", 1, 0),
         Tuberculosis = if_else(Tuberculosis == "YES", 1, 0),
         Sleep_apnea = if_else(Sleep_apnea == "YES", 1, 0),
         Celiac_disease = if_else(Celiac_disease == "YES", 1, 0),
         Crohn = if_else(Crohn == "YES", 1, 0),
         Rheumatic_disease = if_else(Rheumatic_disease == "YES", 1, 0))
```

check if the metadata are similar with the manifest metadata for SCAPIS and IGT. Check for identity in Sex and Age columns.

For both datasets the differences are that different DAids are present in the metadata and manifest metadata. The difference size is small however.

```{r}
# SCAPIS
daids_not_in_metadata <- scapis_DAid |> 
  setdiff(metadata_preprocessed$DAid)
print(paste("DAids not present in Goran metadata (", 
            length(daids_not_in_metadata), 
            "):", 
            toString(daids_not_in_metadata)))

check_metadata <- metadata_preprocessed |> 
  filter(DAid %in% scapis_DAid) |>
  select(DAid, Sex, Age) |> 
  left_join(metadata_scapis |> select(DAid, Sex, Age), by = "DAid") |> 
  filter(
    (Sex.x != Sex.y) | (is.na(Sex.x) != is.na(Sex.y)) |
    (Age.x != Age.y) | (is.na(Age.x) != is.na(Age.y))
  )

problem_samples <- check_metadata$DAid
print(paste("DAids with different Sex and Age between Goran and manifest metadata (",
            length(problem_samples), 
            "):", 
            toString(problem_samples)))
```

```{r}
# IGT
daids_not_in_metadata <- igt_DAid |> 
  setdiff(metadata_preprocessed$DAid)
print(paste("DAids not present in Goran metadata (", 
            length(daids_not_in_metadata), 
            "):",
            toString(daids_not_in_metadata)))

check_metadata <- metadata_preprocessed |> 
  filter(DAid %in% igt_DAid) |>
  select(DAid, Sex, Age) |> 
  left_join(metadata_igt |> select(DAid, Sex, Age), by = "DAid") |> 
  filter(
    (Sex.x != Sex.y) | (is.na(Sex.x) != is.na(Sex.y)) |
    (Age.x != Age.y) | (is.na(Age.x) != is.na(Age.y))
  )

problem_samples <- check_metadata$DAid
print(paste("DAids with different Sex and Age between Goran and manifest metadata (",
            length(problem_samples), 
            "):", 
            toString(problem_samples)))
```

## Data QC

All missing values are in 5 (SCAPIS) and 9 (IGT) samples, but still the maximum NA percentage is less than 25%. There are the typical clusters of correlated proteins in Olink data.

```{r}
qc_summary_data(data_scapis, threshold = 0.9)
qc_summary_data(data_igt, threshold = 0.9)
```

## Impute missing values

```{r}
data_scapis_imputed <- impute_knn(data_scapis, exclude_cols = "DAid", show_na_percentage = FALSE)
data_igt_imputed <- impute_knn(data_igt, exclude_cols = "DAid", show_na_percentage = FALSE)
```

## Join data and metadata

```{r}
metadata_cols <- c("DAid", "Sex", "Age", "Smoke_status", "SBP_Mean", "DBP_Mean", "HbA1c", "Chol", "LDL", "HDL", "TG", "ALT", "GGT", "Urate", "Crea", "eGFR", "CRP", "Hb", "WBC", "PLT", "Hten_med", "Lipid_med", "Obesity", "IGT", "MS", "MASLD", "carotidplaque", "CAC")

data_scapis_joined <- left_join(data_scapis_imputed, 
                                metadata_preprocessed |> select(all_of(metadata_cols)), 
                                by = "DAid") |> 
  select(DAid, all_of(metadata_cols), everything())

data_igt_joined <- left_join(data_igt_imputed, 
                             metadata_preprocessed |> select(all_of(metadata_cols)), 
                             by = "DAid") |>
  select(DAid, all_of(metadata_cols), everything())
```

# Explorative Data Analysis

Very similar distributions between the 2 datasets regarding both Sex and Age.

```{r}
metadata_preprocessed |> 
  mutate(Cohort = if_else(DAid %in% scapis_DAid, "SCAPIS", "IGT")) |> 
  count(Sex, Cohort) |> 
  ggplot(aes(x = n, y = Cohort, fill = Sex)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(x = "Number of samples", y = "") +
  scale_fill_hpa("sex_hpa") + 
  theme_hpa()

metadata_preprocessed |> 
  mutate(Cohort = if_else(DAid %in% scapis_DAid, "SCAPIS", "IGT")) |> 
  select(Age, Cohort) |> 
  ggplot2::ggplot(ggplot2::aes(x = Age, y = Cohort, fill = Cohort)) +
  geom_density_ridges2(quantile_lines = TRUE, alpha = 0.7, quantiles = 2, scale = 1) +
  labs(x = "Age", y = "") +
  theme_hpa() +
  theme(legend.position = "none")
```

Number of diseases in the 2 datasets.

```{r}
disease_cols <- c("Obesity", "MS", "MASLD", "CAC", "carotidplaque", "Myocardial_infarction", "Atrial_fibrillation", "Coronary_artery_intervention", "Stroke", "COPD", "Asthma", "Tuberculosis", "Sleep_apnea", "Celiac_disease", "Crohn", "Rheumatic_disease", "IGT")

metadata_preprocessed |> 
  mutate(Cohort = if_else(DAid %in% scapis_DAid, "SCAPIS", "IGT")) |> 
  select(DAid, Cohort, all_of(disease_cols)) |> 
  pivot_longer(cols = -c("DAid", "Cohort"), names_to = "Disease", values_to = "Status") |>
  filter(Status != 0) |> 
  count(Disease, Cohort) |> 
  ggplot(aes(x = n, y = Disease)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 0.1, hjust = -0.5, color = "black", size = 3) +
  labs(x = "Number of samples", y = "") +
  facet_wrap(~Cohort, scales = "free_y", nrow = 2) +
  theme_hpa()
```

Check the correlation between the different disease classes. We see a big block. Myocardial infarction and coronary artery intervention are highly correlated and into the block but they only have few samples each (around 20 in each cohort).

> Sleep apnea might be a decent disease with decent sample size to be considered.

```{r}
cor_matrix <- metadata_preprocessed |> 
  select(all_of(disease_cols)) |> 
  cor(use = "pairwise.complete.obs", method = "spearman") |> 
  round(2)

corrplot(cor_matrix, 
         method = "square",  
         tl.srt = 45,
         tl.col = "black",
         order = "hclust",
         hclust.method = "ward.D2") 
```

> Maybe also Asthma?

```{r}
# SCAPIS
metadata_preprocessed |> 
  mutate(Cohort = if_else(DAid %in% scapis_DAid, "SCAPIS", "IGT")) |> 
  filter(Cohort == "SCAPIS") |>
  select(DAid, Cohort, Sex, Age, BMI, all_of(disease_cols)) |> 
  pivot_longer(cols = -c("DAid", "Cohort", "Sex", "Age", "BMI"), names_to = "Disease", values_to = "Status") |> 
  tidyheatmap(
    rows = Disease,
    columns = DAid,
    values = Status,
    colors = c("lightgrey", "red"),
    annotation_col = c(Age, Sex, BMI),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    legend_breaks = c(0, 1),
    legend_labels = c("NO", "YES"),
    show_colnames = FALSE,
    clustering_method = "ward.D2")
```

```{r}
# IGT
metadata_preprocessed |> 
  mutate(Cohort = if_else(DAid %in% scapis_DAid, "SCAPIS", "IGT")) |> 
  filter(Cohort == "IGT") |>
  select(DAid, Cohort, Sex, Age, BMI, all_of(disease_cols)) |> 
  pivot_longer(cols = -c("DAid", "Cohort", "Sex", "Age", "BMI"), names_to = "Disease", values_to = "Status") |> 
  tidyheatmap(
    rows = Disease,
    columns = DAid,
    values = Status,
    colors = c("lightgrey", "red"),
    annotation_col = c(Age, Sex, BMI),
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    legend_breaks = c(0, 1),
    legend_labels = c("NO", "YES"),
    show_colnames = FALSE,
    clustering_method = "ward.D2")
```

Correlate other metadata with the diseases. From this plot however sleep apnea and asthma look irrelevant...

```{r}
metadata_cols <- c("Obesity", "MS", "MASLD", "CAC", "carotidplaque", "Myocardial_infarction", "Atrial_fibrillation", "Coronary_artery_intervention", "Stroke", "COPD", "Asthma", "Tuberculosis", "Sleep_apnea", "Celiac_disease", "Crohn", "Rheumatic_disease", "IGT", "Weight", "BMI", "Waist", "SBP_Mean", "DBP_Mean", "Glucose", "HbA1c", "HOMA_IR", "Chol", "LDL", "HDL", "TG", "ALT", "GGT", "Urate", "Crea", "eGFR", "CRP", "Hb", "WBC", "PLT", "Sex", "Age")

cor_matrix <- metadata_preprocessed |> 
  select(all_of(metadata_cols)) |> 
  mutate(Sex = if_else(Sex == "F", 1, 0)) |> 
  cor(use = "pairwise.complete.obs", method = "spearman") |> 
  round(2)

corrplot(cor_matrix, 
         method = "square",  
         tl.srt = 45,
         tl.col = "black",
         order = "hclust",
         hclust.method = "ward.D2")
```

# UMAP

There are no extreme outliers at all. There is a small cluster of points bellow. There is no separation with most the parameters. There might be a small separation with BMI/Obesity.

Check if there are Cohort effects.

```{r}
all_data_imputed <- rbind(data_scapis_imputed, data_igt_imputed)
do_umap(all_data_imputed, 
        metadata_preprocessed |>
          mutate(Cohort = if_else(DAid %in% scapis_DAid, "SCAPIS", "IGT")),
        color = "Cohort")
```

Check for sex, age and BMI effects.

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed,
        color = "Sex",
        palette = "sex_hpa")
```

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed,
        color = "Age")
```

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed,
        color = "BMI")
```

Check CAC, Obesity, Carotid plaque and Glucose groups clusters.

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed |> mutate(CAC = if_else(CAC == 1, "YES", "NO")),
        color = "CAC")
```

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed |> mutate(Obesity = if_else(Obesity == 1, "YES", "NO")),
        color = "Obesity")
```

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed |> mutate(carotidplaque = if_else(carotidplaque == 1, "YES", "NO")),
        color = "carotidplaque")
```

```{r}
do_umap(all_data_imputed, 
        metadata_preprocessed,
        color = "glucose.group")
```

# Processed the Joined Datasets

Check for NAs in metadata columns of joined datasets.

```{r}
na_count_scapis <- colSums(is.na(data_scapis_final))
na_count_scapis[na_count_scapis > 0]

na_count_igt <- colSums(is.na(data_igt_final))
na_count_igt[na_count_igt > 0]
```

Remove rows containing NA values in diseases of interest, Sex and Age. We lost 75 patients from SCAPIS cohort.

```{r}
print(paste("Before NA removal we had:", nrow(data_scapis_joined), "patients in SCAPIS"))
data_scapis_final <- data_scapis_joined |> 
  filter(!is.na(Obesity), 
         !is.na(MS), 
         !is.na(MASLD), 
         !is.na(CAC),
         !is.na(IGT),
         !is.na(Sex), 
         !is.na(Age))

print(paste("After NA removal we have:", nrow(data_scapis_final), "patients in SCAPIS"))
```

```{r}
print(paste("Before NA removal we had:", nrow(data_igt_final), "patients in IGT"))
data_igt_final <- data_igt_joined |> 
  filter(!is.na(Obesity), 
         !is.na(MS), 
         !is.na(MASLD), 
         !is.na(CAC),
         !is.na(IGT),
         !is.na(Sex), 
         !is.na(Age))

print(paste("After NA removal we have:", nrow(data_igt_final), "patients in IGT"))
```

# Save Data
