---
title: "main"
format: html
editor: visual
---

# Set-up

```{r setup, message = FALSE, warning = FALSE, results = 'hide'}
library(HDAnalyzeR)
library(tidyverse)
library(tidymodels)
```

# Input Data & Metadata

```{r, message = FALSE, results = 'hide'}
long_data <- import_df("data/raw_data/IGT_SCAPIS_preprocessed_data.tsv")

metadata <- import_df("data/raw_data/IGTM_SCAPIS_metadata_230406.txt")
metadata_scapis <- import_df("data/raw_data/scapis_metadata_manifest.xlsx")
metadata_igt <- import_df("data/raw_data/igts_metadata_manifest.xlsx")
```

# Data Preprocessing

## Prepare Data

Get the unique DAid from the metadata files (SCAPIS and IGT).

```{r}
scapis_DAid <- metadata_scapis$DAid |> unique()
igt_DAid <- metadata_igt$DAid |> unique()
```

Separate data and make them wide.

> Should I filter Assays or Runs before?

```{r}
data_scapis <- long_data |> filter(DAid %in% scapis_DAid)
data_igt <- long_data |> filter(DAid %in% igt_DAid)

data_scapis <- widen_data(data_scapis)
data_igt <- widen_data(data_igt)
```

## Prepare metadata

Rename and modify the metadata columns.

```{r}
metadata_preprocessed <- metadata |> 
  rename(Age = AgeAtVisitOne, Sex = Gender) |> 
  mutate(Age = Age |> as.numeric() |> floor()) |> 
  mutate(Sex = if_else(Sex == "MALE", "M", "F"))
```

check if the metadata are similar with the manifest metadata for SCAPIS and IGT.

For both datasets the differences are that different DAids are present in the metadata and manifest metadata. The difference size is small however.

```{r}
# SCAPIS
daids_not_in_metadata <- scapis_DAid |> 
  setdiff(metadata_preprocessed$DAid)
print(paste("DAids not present in Goran metadata (", 
            length(daids_not_in_metadata), 
            "):", 
            toString(daids_not_in_metadata)))

check_metadata <- metadata_preprocessed |> 
  filter(DAid %in% scapis_DAid) |>
  select(DAid, Sex, Age, BMI) |> 
  left_join(metadata_scapis |> select(DAid, Sex, Age, BMI), by = "DAid") |> 
  filter(
    (Sex.x != Sex.y) | (is.na(Sex.x) != is.na(Sex.y)) |
    (Age.x != Age.y) | (is.na(Age.x) != is.na(Age.y)) |
    (BMI.x != BMI.y) | (is.na(BMI.x) != is.na(BMI.y))
  )

problem_samples <- check_metadata$DAid
print(paste("DAids with different Sex, Age, BMI between Goran and manifest metadata (",
            length(problem_samples), 
            "):", 
            toString(problem_samples)))
```

```{r}
# IGT
daids_not_in_metadata <- igt_DAid |> 
  setdiff(metadata_preprocessed$DAid)
print(paste("DAids not present in Goran metadata (", 
            length(daids_not_in_metadata), 
            "):",
            toString(daids_not_in_metadata)))

check_metadata <- metadata_preprocessed |> 
  filter(DAid %in% igt_DAid) |>
  select(DAid, Sex, Age, BMI) |> 
  left_join(metadata_igt |> select(DAid, Sex, Age, BMI), by = "DAid") |> 
  filter(
    (Sex.x != Sex.y) | (is.na(Sex.x) != is.na(Sex.y)) |
    (Age.x != Age.y) | (is.na(Age.x) != is.na(Age.y)) |
    (BMI.x != BMI.y) | (is.na(BMI.x) != is.na(BMI.y))
  )

problem_samples <- check_metadata$DAid
print(paste("DAids with different Sex, Age, BMI between Goran and manifest metadata (",
            length(problem_samples), 
            "):", 
            toString(problem_samples)))
```

